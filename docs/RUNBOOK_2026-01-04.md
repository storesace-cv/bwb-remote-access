# Runbook - January 4, 2026

## Summary of Changes

This update fixes lint warnings by implementing actual security and correctness logic.

### Files Changed

1. **`/src/app/api/mesh/devices/route.ts`**
   - Added domain access enforcement using `canAccessDomain()`
   - Returns 403 if user attempts to access a domain they're not authorized for

2. **`/src/app/api/mesh/open-session/route.ts`**
   - Removed unused imports (`getShortDomain`, `isSuperAdmin`) - already handled in authorization logic

3. **`/src/lib/mesh-auth.ts`**
   - Now explicitly handles database fetch errors
   - Logs errors for debugging instead of silently failing

4. **`/src/lib/rbac-mesh.ts`**
   - Removed unused `getSupabase()` function and `@supabase/supabase-js` import
   - Supabase access is properly handled via `getMeshUserByEmail()` in mesh-auth.ts

5. **`/src/lib/user-mirror.ts`**
   - Added `isValidDomain()` validation function
   - `upsertMirrorUser()` now validates domain before database writes
   - Prevents invalid domain values from entering the database

### Migration Status

The baseline migration for `android_devices` already exists:
- File: `supabase/migrations/20251207000000_baseline_android_devices.sql`
- Timestamp: BEFORE first migration that depends on it
- Content: Idempotent (CREATE IF NOT EXISTS) table creation

### Deploy Script Status

Step-4 (`scripts/Step-4-deploy-tested-build.sh`) already includes:
- Supabase CLI availability check
- `supabase db push` execution before deploy
- Deploy abort on migration failure

---

## Commands to Run on Mac

### 1. Install Dependencies (if not done)
```bash
cd /path/to/my-bwb-remote-access
npm ci
```

### 2. Run Linter
```bash
npm run lint
```
Expected: No errors, no warnings.

### 3. Build
```bash
npm run build
```
Expected: Successful build with no errors.

### 4. Link Supabase Project (if not already linked)
```bash
supabase link --project-ref <your-project-ref>
```
Note: Run this only once per machine. Check if already linked:
```bash
cat supabase/.temp/project-ref
```

### 5. Test Migrations Locally (Optional)
```bash
supabase db push --dry-run
```
This shows what would be applied without actually running it.

### 6. Apply Migrations
```bash
supabase db push
```
This applies all pending migrations to the remote Supabase database.

### 7. Deploy to Droplet
```bash
./scripts/Step-4-deploy-tested-build.sh
```

The script will:
1. Run compliance checks (middleware, no Auth0, etc.)
2. Run `supabase db push` (migrations)
3. Upload files to droplet
4. Build on droplet
5. Start service
6. Run post-deploy validation

---

## Verification

After deploy, verify at: `https://rustdesk.bwb.pt`

1. **Login page**: Should load at `/login`
2. **Protected routes**: Should redirect to login when not authenticated
3. **Dashboard**: Should load after successful login

---

## Rollback

If issues occur, the previous code is in git. On your Mac:

```bash
git log --oneline -10  # Find previous commit
git checkout <commit-sha> -- <file>  # Restore specific file
```

Or use the "rollback" option in Emergent if available.
